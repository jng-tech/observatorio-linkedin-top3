name: Refresh LinkedIn Top3

on:
  # Ejecutar cada hora (el gate interno filtra solo 19:00+ Europe/Madrid)
  schedule:
    - cron: '0 * * * *'
  # Permitir ejecución manual (útil para testing)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────────────────────────────
      # 1. Checkout del repositorio
      # ─────────────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────────────
      # 2. Setup Node.js
      # ─────────────────────────────────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ─────────────────────────────────────────────────────────────────────
      # 3. Instalar dependencias
      # ─────────────────────────────────────────────────────────────────────
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # ─────────────────────────────────────────────────────────────────────
      # 4. Instalar Playwright + Chromium
      # ─────────────────────────────────────────────────────────────────────
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # ─────────────────────────────────────────────────────────────────────
      # 5. Instalar xvfb para display virtual (reduce checkpoint)
      # ─────────────────────────────────────────────────────────────────────
      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      # ─────────────────────────────────────────────────────────────────────
      # 6. Gate horario: solo ejecutar si es >= 19:00 Europe/Madrid
      #    y no se ha ejecutado hoy
      #    IMPORTANTE: este step SIEMPRE termina con exit 0
      #    y comunica si toca correr via steps.gate.outputs.run
      # ─────────────────────────────────────────────────────────────────────
      - name: Check time gate (Europe/Madrid >= 19:00)
        id: gate
        run: |
          node -e "
            const fs = require('fs');

            // Obtener hora y fecha en Europe/Madrid
            const fmt = new Intl.DateTimeFormat('sv-SE', {
              timeZone: 'Europe/Madrid',
              hour: '2-digit',
              minute: '2-digit',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });

            const parts = fmt.formatToParts(new Date());
            const obj = Object.fromEntries(parts.map(p => [p.type, p.value]));

            const hour = Number(obj.hour);
            const today = obj.year + '-' + obj.month + '-' + obj.day;

            // Leer última fecha de refresh
            const stampFile = '.last_refresh_date';
            const lastRefresh = fs.existsSync(stampFile)
              ? fs.readFileSync(stampFile, 'utf8').trim()
              : '';

            // Condiciones: hora >= 19 Y no se ha ejecutado hoy
            const shouldRun = hour >= 19 && lastRefresh !== today;

            console.log('=== TIME GATE CHECK ===');
            console.log('Europe/Madrid time:', obj.hour + ':' + obj.minute);
            console.log('Today (Madrid):', today);
            console.log('Last refresh:', lastRefresh || '(never)');
            console.log('Hour >= 19?', hour >= 19);
            console.log('Not refreshed today?', lastRefresh !== today);
            console.log('Should run?', shouldRun);

            // Exportar output para condicionar el resto de steps
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'run=' + (shouldRun ? 'true' : 'false') + '\\n');

            if (shouldRun) {
              fs.writeFileSync(stampFile, today);
              console.log('Gate PASSED - proceeding with refresh');
            } else {
              console.log('Gate BLOCKED - skipping refresh (expected)');
            }

            // SIEMPRE exit 0 => no emails de failure
            process.exit(0);
          "

      # ─────────────────────────────────────────────────────────────────────
      # 7. Validar que existe el secret LI_STATE_B64
      # ─────────────────────────────────────────────────────────────────────
      - name: Validate LI_STATE_B64 secret
        if: steps.gate.outputs.run == 'true'
        env:
          LI_STATE_B64: ${{ secrets.LI_STATE_B64 }}
        run: |
          if [ -z "$LI_STATE_B64" ]; then
            echo "::error::Secret LI_STATE_B64 is not defined!"
            echo ""
            echo "To fix this:"
            echo "1. Run 'npm run login' locally"
            echo "2. Encode the session: base64 -i state/linkedin.json"
            echo "3. Add it as a GitHub Secret named LI_STATE_B64"
            exit 1
          fi
          echo "LI_STATE_B64 secret is configured"

      # ─────────────────────────────────────────────────────────────────────
      # 8. Reconstruir state/linkedin.json desde secret
      # ─────────────────────────────────────────────────────────────────────
      - name: Restore LinkedIn session from secret
        if: steps.gate.outputs.run == 'true'
        env:
          LI_STATE_B64: ${{ secrets.LI_STATE_B64 }}
        run: |
          mkdir -p state

          # Intentar base64 -d (Linux) o base64 --decode (fallback)
          if echo "$LI_STATE_B64" | base64 -d > state/linkedin.json 2>/dev/null; then
            echo "Session restored using base64 -d"
          elif echo "$LI_STATE_B64" | base64 --decode > state/linkedin.json 2>/dev/null; then
            echo "Session restored using base64 --decode"
          else
            echo "::error::Failed to decode LI_STATE_B64"
            exit 1
          fi

          # Validar que es JSON válido
          if ! node -e "JSON.parse(require('fs').readFileSync('state/linkedin.json','utf8'))"; then
            echo "::error::LI_STATE_B64 does not contain valid JSON"
            exit 1
          fi

          echo "LinkedIn session file created successfully"

      # ─────────────────────────────────────────────────────────────────────
      # 9. Ejecutar scraper con display virtual (modo headed para reducir checkpoint)
      # ─────────────────────────────────────────────────────────────────────
      - name: Fetch LinkedIn Top 3
        if: steps.gate.outputs.run == 'true'
        env:
          CI_HEADFUL: "1"
        run: xvfb-run -a npm run fetch

      # ─────────────────────────────────────────────────────────────────────
      # 10. Commit y push de los cambios
      # ─────────────────────────────────────────────────────────────────────
      - name: Commit and push changes
        if: steps.gate.outputs.run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Añadir archivos modificados (no falla si alguno no existe)
          git add public/ .last_refresh_date

          # Verificar si hay cambios para commitear
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Daily refresh $(TZ='Europe/Madrid' date +'%Y-%m-%d %H:%M') Madrid"
            git push
            echo "Changes committed and pushed successfully"
          fi

      # ─────────────────────────────────────────────────────────────────────
      # 11. Resumen final
      # ─────────────────────────────────────────────────────────────────────
      - name: Summary
        if: always()
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          echo "Gate run?: ${{ steps.gate.outputs.run }}"
          if [ "${{ steps.gate.outputs.run }}" == "true" ]; then
            echo "Refresh was executed"
          else
            echo "Refresh was skipped (gate blocked)"
          fi
